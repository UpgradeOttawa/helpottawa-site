<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Eastern Ontario Hazard Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    #map { position: absolute; top: 60px; bottom: 100px; left: 0; right: 0; }
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: white; display: flex; align-items: center; padding: 0 20px;
      z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .topbar h1 { font-size: 22px; font-weight: 600; }
    .controls {
      position: fixed; bottom: 0; left: 0; right: 0; height: 100px;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
      color: white; padding: 15px 20px; z-index: 1000;
    }
    .control-row { display: flex; gap: 20px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 8px; }
    .control-group label { font-size: 14px; white-space: nowrap; }
    .control-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .control-group select { padding: 6px 12px; border-radius: 4px; background: #333; color: white; border: 1px solid #555; cursor: pointer; }
    .btn { padding: 8px 16px; border-radius: 4px; background: #0066cc; color: white; border: none; cursor: pointer; font-weight: 600; }
    .btn:hover { background: #0052a3; }
    .info { font-size: 13px; color: #aaa; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>üó∫Ô∏è Eastern Ontario Hazard Map</h1>
  </div>
  
  <div id="map"></div>
  
  <div class="controls">
    <div class="control-row">
      <div class="control-group">
        <input type="checkbox" id="toggleHeat" checked>
        <label for="toggleHeat">Heatmap</label>
      </div>
      <div class="control-group">
        <label for="hazardType">Hazard:</label>
        <select id="hazardType">
          <option value="asbestos">Asbestos</option>
          <option value="lead">Lead Paint</option>
          <option value="radon">Radon</option>
          <option value="mold">Mold</option>
        </select>
      </div>
      <div class="control-group">
        <label for="intensity">Intensity:</label>
        <select id="intensity">
          <option value="0.3">Low</option>
          <option value="0.6" selected>Medium</option>
          <option value="0.9">High</option>
        </select>
      </div>
      <button class="btn" onclick="clearObservations()">Clear All</button>
    </div>
    <div class="info">
      Click anywhere on the map to add a hazard observation (privacy-protected with 200m scatter)
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  
  <script>
    const map = L.map('map').setView([45.428, -75.59], 11);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap'
    }).addTo(map);
    
    let heatLayer = null;
    let heatPoints = [];
    
    // Load saved observations
    function loadObservations() {
      try {
        const saved = localStorage.getItem('hazard_observations');
        return saved ? JSON.parse(saved) : [];
      } catch { return []; }
    }
    
    function saveObservations() {
      try {
        localStorage.setItem('hazard_observations', JSON.stringify(heatPoints));
      } catch {}
    }
    
    function updateHeatmap() {
      if (heatLayer) map.removeLayer(heatLayer);
      
      const toggle = document.getElementById('toggleHeat');
      if (toggle && toggle.checked && heatPoints.length > 0) {
        heatLayer = L.heatLayer(heatPoints, {
          radius: 35,
          blur: 25,
          maxZoom: 17,
          gradient: {0.4: 'blue', 0.6: 'yellow', 0.8: 'orange', 1.0: 'red'}
        }).addTo(map);
      }
    }
    
    function addObservation(lat, lng, intensity) {
      // Add scattered points for privacy (¬±200m)
      for (let i = 0; i < 20; i++) {
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * 0.002; // ~200m
        const dx = Math.cos(angle) * radius;
        const dy = Math.sin(angle) * radius;
        heatPoints.push([lat + dy, lng + dx, intensity * (0.7 + Math.random() * 0.3)]);
      }
      saveObservations();
      updateHeatmap();
    }
    
    function clearObservations() {
      if (confirm('Clear all observations?')) {
        heatPoints = [];
        saveObservations();
        updateHeatmap();
      }
    }
    
    // Map click handler
    map.on('click', (e) => {
      const intensity = parseFloat(document.getElementById('intensity').value);
      const hazard = document.getElementById('hazardType').value;
      addObservation(e.latlng.lat, e.latlng.lng, intensity);
      
      L.popup()
        .setLatLng(e.latlng)
        .setContent(`<b>${hazard} observation added</b><br>Risk level: ${intensity > 0.7 ? 'High' : intensity > 0.4 ? 'Medium' : 'Low'}<br><small>Data scattered ¬±200m for privacy</small>`)
        .openOn(map);
    });
    
    // Toggle handler
    document.getElementById('toggleHeat').addEventListener('change', updateHeatmap);
    
    // Load saved data
    heatPoints = loadObservations();
    updateHeatmap();
    
    // Add some demo points for Orl√©ans
    if (heatPoints.length === 0) {
      const demoPoints = [
        [45.47, -75.52, 0.7],  // Orl√©ans area
        [45.45, -75.50, 0.6],
        [45.42, -75.68, 0.8],  // Downtown Ottawa
        [45.40, -75.70, 0.5]
      ];
      demoPoints.forEach(([lat, lng, int]) => {
        for (let i = 0; i < 15; i++) {
          const angle = Math.random() * Math.PI * 2;
          const radius = Math.random() * 0.01;
          heatPoints.push([
            lat + Math.cos(angle) * radius,
            lng + Math.sin(angle) * radius,
            int * (0.8 + Math.random() * 0.2)
          ]);
        }
      });
      updateHeatmap();
    }
  </script>
</body>
</html>
